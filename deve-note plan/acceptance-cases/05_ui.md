## UI 设计与交互

```markdown
- case_id: UI-GEN-001
  goal: Design Tokens 使用 CSS 变量。
  preconditions:
    - 文件存在: apps/web/style/*.css
  steps:
    - run: rg -n "#([0-9a-fA-F]{3,6})" "apps/web/style"
  assertions:
    - stdout_not_contains: "#"  # 不出现硬编码 Hex

- case_id: UI-GEN-002
  goal: Z-Index Registry 分层无冲突。
  preconditions:
    - 应用已运行
  steps:
    - ui_open_modal: "Command Palette"
    - ui_trigger_toast: true
  assertions:
    - ui_assert: modal_above_overlay true
    - ui_assert: toast_above_modal true

- case_id: UI-GEN-003
  goal: Focus Trap/Restore。
  preconditions:
    - 应用已运行
  steps:
    - ui_open_modal: "Command Palette"
    - ui_keypress: "Tab" (repeat: 5)
    - ui_close_modal: true
  assertions:
    - ui_assert: focus_stays_inside_modal true
    - ui_assert: focus_restored_to_editor true

- case_id: UI-WEB-001
  goal: SPA 路由回退。
  preconditions:
    - Web 端已运行
  steps:
    - browser_open: "http://localhost:3000/any/path"
    - browser_reload: true
  assertions:
    - http_status_eq: 200
    - ui_assert: app_loaded true

- case_id: UI-WEB-002
  goal: 断连锁屏。
  preconditions:
    - WebSocket 已连接
  steps:
    - net_block_ws: true
  assertions:
    - ui_assert: overlay_text "Reconnecting..."
    - ui_assert: editing_disabled true

- case_id: UI-WEB-003
  goal: Dashboard 刷新策略。
  preconditions:
    - 访问 `/`
  steps:
    - ui_wait: 6000
  assertions:
    - ui_assert: system_health_refreshed true
    - ui_assert: sync_status_updates_via_ws true

- case_id: UI-DESK-001
  goal: 5 列网格与 Diff 分屏滚动同步。
  preconditions:
    - 桌面视口
  steps:
    - ui_toggle_diff_mode: true
    - ui_scroll: "editor_col3" (delta: 300)
  assertions:
    - ui_assert: col2_scroll_synced true

- case_id: UI-DESK-002
  goal: Sidebar/Panel 拖拽与持久化。
  preconditions:
    - 桌面视口
  steps:
    - ui_drag_resizer: "sidebar" (to: 300)
    - browser_reload: true
  assertions:
    - ui_assert: sidebar_width_eq 300

- case_id: UI-DESK-003
  goal: Unified Search 模式切换。
  preconditions:
    - 打开 Unified Search
  steps:
    - ui_type: ">toggle"
    - ui_type: "@branch"
    - ui_type: "file.md"
  assertions:
    - ui_assert: mode_eq "command"
    - ui_assert: mode_eq "branch"
    - ui_assert: mode_eq "file"

- case_id: UI-MOB-001
  goal: 移动端视口映射。
  preconditions:
    - 浏览器视口宽度 <= 768
  steps:
    - browser_set_viewport: [375, 812]
    - browser_reload: true
  assertions:
    - ui_assert: layout_mode_eq "mobile"

- case_id: UI-MOB-002
  goal: Drawer 与 Edge Swipe。
  preconditions:
    - 移动端视口
  steps:
    - ui_edge_swipe: "left" (distance: 80)
    - ui_edge_swipe: "right" (distance: 80)
  assertions:
    - ui_assert: left_drawer_open true
    - ui_assert: right_drawer_open true

- case_id: UI-MOB-003
  goal: 移动端无拉伸手柄。
  preconditions:
    - 移动端视口
  steps:
    - ui_query_dom: ".resizer-handle"
  assertions:
    - ui_dom_count_eq: 0

- case_id: UI-MOB-004
  goal: Mobile Toolbar 与键盘适配。
  preconditions:
    - 移动端视口
  steps:
    - ui_focus_editor: true
    - ui_wait_keyboard: true
  assertions:
    - ui_assert: toolbar_visible true
    - ui_assert: toolbar_not_overlapped_by_keyboard true

- case_id: UI-MOB-005
  goal: Top Sheet 搜索面板从顶部展开并可上滑关闭。
  preconditions:
    - 移动端视口
  steps:
    - ui_open_search: true
    - ui_assert: search_sheet_position "top"
    - ui_swipe: "search_sheet_handle" (direction: "up", distance: 90)
  assertions:
    - ui_assert: search_sheet_closed true

- case_id: UI-MOB-006
  goal: Top Sheet 手势与结果滚动不冲突。
  preconditions:
    - 搜索结果可滚动
  steps:
    - ui_open_search: true
    - ui_scroll: "search_results" (delta: 200)
    - ui_swipe: "search_results" (direction: "up", distance: 80)
  assertions:
    - ui_assert: search_sheet_closed false

- case_id: UI-MOB-007
  goal: Bottom Bar 折叠态单行显示关键状态。
  preconditions:
    - 移动端视口
  steps:
    - ui_query_text: "Branch"
    - ui_query_text: "Ready"
    - ui_query_text: "Words"
    - ui_query_text: "Lines"
    - ui_query_text: "Col"
  assertions:
    - ui_assert: bottom_bar_collapsed true
    - ui_assert: bottom_bar_single_line true

- case_id: UI-MOB-008
  goal: Bottom Bar 可展开/收起，点击栏外自动收起。
  preconditions:
    - 移动端视口
  steps:
    - ui_click: "bottom_bar_toggle"
    - ui_assert: bottom_bar_expanded true
    - ui_click: "outside_bottom_bar"
  assertions:
    - ui_assert: bottom_bar_collapsed true

- case_id: UI-MOB-009
  goal: 移动端按钮可达性命中区 >= 44px。
  preconditions:
    - 移动端视口
  steps:
    - ui_measure: "topbar_buttons"
    - ui_measure: "drawer_close_buttons"
    - ui_measure: "outline_toggle"
    - ui_measure: "bottom_bar_toggle"
  assertions:
    - ui_assert: all_targets_min_size "44x44"

- case_id: UI-MOB-010
  goal: 移动端新增文案接入 i18n，无硬编码回归。
  preconditions:
    - 本地仓库可检索
  steps:
    - run: rg -n "File tree|Close file tree|Toggle status details|Outline unavailable|No headings found" "apps/web/src/components/mobile_layout"
  assertions:
    - stdout_contains: "t::"

- case_id: UI-MOB-011
  goal: AI Chat 移动端展开为同页全屏页面，并可关闭返回原页面。
  preconditions:
    - 浏览器视口宽度 <= 768
    - 聊天面板已启用
  steps:
    - ui_click: "mobile_chat_chip"
    - ui_assert: chat_page_fullscreen true
    - ui_click: "chat_close_button"
  assertions:
    - ui_assert: chat_page_fullscreen false
    - ui_assert: editor_visible true

- case_id: UI-MOB-012
  goal: AI Chat 输入区在键盘弹起时可见且发送按钮可达。
  preconditions:
    - 移动端视口
    - AI Chat 已展开
  steps:
    - ui_focus: "chat_input"
    - ui_wait_keyboard: true
    - ui_measure: "chat_send_button"
  assertions:
    - ui_assert: chat_input_not_overlapped_by_keyboard true
    - ui_assert: min_target_size "44x44"

- case_id: UI-MOB-013
  goal: AI Chat 移动端消息可读性（长文本与代码块）。
  preconditions:
    - 移动端视口
    - AI Chat 已展开
  steps:
    - ui_send_chat_text: "long_text_and_code_sample"
    - ui_wait: 500
  assertions:
    - ui_assert: chat_message_wrap_enabled true
    - ui_assert: chat_code_block_horizontal_scroll true
    - ui_assert: chat_message_timestamp_visible true

- case_id: UI-MOB-014
  goal: AI Chat 错误态/重试态可见且可恢复。
  preconditions:
    - 移动端视口
    - AI 插件返回错误
  steps:
    - ui_send_chat_text: "trigger_error"
    - ui_click: "chat_retry_button"
  assertions:
    - ui_assert: chat_error_banner_visible true
    - ui_assert: retry_action_triggered true

- case_id: UI-MOB-015
  goal: 移动端左抽屉与桌面一致提供图标化侧栏入口与 More 菜单。
  preconditions:
    - 浏览器视口宽度 <= 768
  steps:
    - ui_open_drawer: "left"
    - ui_assert: sidebar_icon_tabs_visible true
    - ui_click: "mobile-more-button"
    - ui_assert: more_menu_visible true
  assertions:
    - ui_assert: sidebar_icon_count_at_least 1
    - ui_assert: more_menu_has_sidebar_entries true

- case_id: UI-MOB-016
  goal: More 菜单关闭策略与固定项行为正确。
  preconditions:
    - 浏览器视口宽度 <= 768
    - 左抽屉已打开
  steps:
    - ui_click: "mobile-more-button"
    - ui_click: "more_menu_item_explorer"
    - ui_assert: more_menu_visible false
    - ui_click: "mobile-more-button"
    - ui_press_key: "Escape"
  assertions:
    - ui_assert: more_menu_visible false
    - ui_assert: pinned_state_updated true

- case_id: UI-MOB-017
  goal: 移动端 Diff 打开时不显示 AI Chat 入口和移动辅助键盘栏。
  preconditions:
    - 浏览器视口宽度 <= 768
    - 已进入 diff 页面
  steps:
    - ui_assert: element_visible ".diff-view-mobile"
  assertions:
    - ui_assert: mobile_chat_chip_visible false
    - ui_assert: mobile_accessory_toolbar_visible false

- case_id: UI-MOB-018
  goal: 移动端 Diff 可通过头部关闭按钮返回编辑页面。
  preconditions:
    - 浏览器视口宽度 <= 768
    - 已进入 diff 页面
  steps:
    - ui_click: ".diff-close-button"
  assertions:
    - ui_assert: element_visible ".diff-view-mobile" false
    - ui_assert: editor_visible true

- case_id: UI-DIFF-001
  goal: Diff 首屏优先渲染可视区，长文档不阻塞首屏展示。
  preconditions:
    - 已进入 diff 页面
    - 变更文件行数 >= 3000
  steps:
    - ui_assert: element_visible ".diff-view-mobile"
    - ui_wait: 120
  assertions:
    - ui_assert: element_visible ".diff-first-viewport-rendered"
    - ui_assert: main_thread_long_task_below_ms 50

- case_id: UI-DIFF-002
  goal: 移动端 Unified Diff 支持编辑，输入按 150ms 防抖后更新预览。
  preconditions:
    - 浏览器视口宽度 <= 768
    - 已进入 diff 页面
  steps:
    - ui_click: ".diff-edit-toggle"
    - ui_type: "textarea" "new line"
    - ui_wait: 120
    - ui_assert: diff_preview_updated false
    - ui_wait: 80
  assertions:
    - ui_assert: diff_preview_updated true

- case_id: UI-DIFF-003
  goal: 桌面端 Diff 打开时 AI Chat 面板保持可见且不被替换。
  preconditions:
    - 桌面视口
    - AI Chat 已打开
  steps:
    - ui_open_diff: true
  assertions:
    - ui_assert: chat_panel_visible true
    - ui_assert: diff_replaces_editor_only true

- case_id: UI-DIFF-004
  goal: Diff 文案接入 i18n，无硬编码回归。
  preconditions:
    - 本地仓库可检索
  steps:
    - run: rg -n "Diff:|Read Only|Preview Diff|Close Diff View" "apps/web/src/components/diff_view"
  assertions:
    - stdout_contains: "t::diff::"

- case_id: UI-DIFF-005
  goal: 移动端 Diff 连续输入 10 次时，计算中提示可见且最终渲染稳定。
  preconditions:
    - 浏览器视口宽度 <= 768
    - 已进入 diff 页面
    - 已切换到编辑态
  steps:
    - ui_repeat: 10
      action:
        - ui_type: "textarea" "x"
        - ui_wait: 20
    - ui_assert: element_visible ".diff-compute-indicator"
    - ui_wait: 220
  assertions:
    - ui_assert: element_visible ".diff-compute-indicator" false
    - ui_assert: element_visible ".diff-first-viewport-rendered"

- case_id: UI-DIFF-006
  goal: Diff 支持按变更块导航（上一处/下一处）并滚动到目标位置。
  preconditions:
    - 已进入 diff 页面
    - 存在至少 2 处变更
  steps:
    - ui_click: ".diff-next-hunk"
    - ui_wait: 60
    - ui_click: ".diff-prev-hunk"
  assertions:
    - ui_assert: diff_scroll_position_changed true

- case_id: UI-DIFF-008
  goal: Diff 支持键盘导航变更块（`]`/`[` 与 `Alt+Down`/`Alt+Up`）。
  preconditions:
    - 已进入 diff 页面
    - 存在至少 2 处变更
  steps:
    - ui_press_key: "]"
    - ui_wait: 50
    - ui_press_key: "["
    - ui_wait: 50
    - ui_press_key: "Alt+ArrowDown"
    - ui_wait: 50
    - ui_press_key: "Alt+ArrowUp"
  assertions:
    - ui_assert: diff_scroll_position_changed true

- case_id: UI-DIFF-009
  goal: Diff 头部显示新增/删除统计。
  preconditions:
    - 已进入 diff 页面
  steps:
    - ui_query_text: "+"
    - ui_query_text: "-"
  assertions:
    - ui_assert: diff_header_change_stats_visible true

- case_id: UI-DIFF-010
  goal: Unified Diff 支持折叠未变更区并可点击展开。
  preconditions:
    - 已进入包含大段未变更内容的 diff 页面
    - 当前为 Unified 视图
  steps:
    - ui_click: ".diff-fold-toggle"
    - ui_assert: element_visible ".diff-fold-row"
    - ui_click: ".diff-fold-row"
  assertions:
    - ui_assert: element_visible ".diff-fold-row" false

- case_id: UI-DIFF-011
  goal: Diff 上下文行数支持 3/5/8 切换并即时生效。
  preconditions:
    - 已进入包含大段未变更内容的 diff 页面
  steps:
    - ui_select: "select[name='diff-context-lines']" "3"
    - ui_assert: element_visible ".diff-fold-row"
    - ui_select: "select[name='diff-context-lines']" "8"
  assertions:
    - ui_assert: fold_row_count_changes true

- case_id: UI-DIFF-012
  goal: Diff 重算后保持语义锚点，视口不发生明显跳变。
  preconditions:
    - 已进入 diff 页面并滚动到中部
    - 当前可见区域包含 data-anchor-key 行
  steps:
    - ui_type: "textarea[name='diff-edit-mobile'], textarea[name='diff-edit-desktop']" "anchor-check"
    - ui_wait: 220
  assertions:
    - ui_assert: diff_semantic_anchor_restored true

- case_id: UI-DIFF-013
  goal: Diff 头部显示缓存命中状态与最近计算耗时。
  preconditions:
    - 已进入 diff 页面
  steps:
    - ui_wait: 60
  assertions:
    - ui_assert: diff_header_cache_badge_visible true
    - ui_assert: diff_header_compute_ms_visible true

- case_id: UI-DIFF-014
  goal: Diff 在内容变更后缓存键失效并重新计算。
  preconditions:
    - 已进入 diff 页面
  steps:
    - ui_assert: diff_header_cache_badge_visible true
    - ui_type: "textarea[name='diff-edit-mobile'], textarea[name='diff-edit-desktop']" "cache-bust"
    - ui_wait: 220
  assertions:
    - ui_assert: diff_header_cache_state_changed true

- case_id: UI-DIFF-015
  goal: Diff 头部显示算法标签（Myers / Patience+Myers）。
  preconditions:
    - 已进入 diff 页面
  steps:
    - ui_wait: 60
  assertions:
    - ui_assert: diff_header_algo_visible true

- case_id: UI-DIFF-016
  goal: Diff 支持 F7 / Shift+F7 变更导航。
  preconditions:
    - 已进入 diff 页面
    - 至少存在两处变更
  steps:
    - ui_press_key: "F7"
    - ui_wait: 60
    - ui_press_key: "Shift+F7"
  assertions:
    - ui_assert: diff_scroll_position_changed true

- case_id: UI-DIFF-017
  goal: Diff 头部显示缓存命中率并随操作更新。
  preconditions:
    - 已进入 diff 页面
  steps:
    - ui_assert: diff_header_cache_ratio_visible true
    - ui_type: "textarea[name='diff-edit-mobile'], textarea[name='diff-edit-desktop']" "ratio-check"
    - ui_wait: 220
  assertions:
    - ui_assert: diff_header_cache_ratio_visible true

- case_id: UI-DIFF-018
  goal: 不同 repo_scope 下 Diff 缓存隔离，避免跨仓错误命中。
  preconditions:
    - 存在两个仓库 A/B，且包含同名文件路径
  steps:
    - ui_switch_repo: "A"
    - ui_open_diff: "path/to/file.md"
    - ui_assert: diff_header_cache_badge_visible true
    - ui_switch_repo: "B"
    - ui_open_diff: "path/to/file.md"
  assertions:
    - ui_assert: diff_header_cache_isolated_between_repos true

- case_id: UI-DIFF-007
  goal: Replace 行具备行内词级高亮。
  preconditions:
    - 已进入包含替换行的 diff 页面
  steps:
    - ui_query_dom: ".diff-word-mark"
  assertions:
    - ui_dom_count_gte: 1
```
